"use strict";(self["webpackChunkecodeco_user_client"]=self["webpackChunkecodeco_user_client"]||[]).push([[349],{59349:(e,t,r)=>{r.r(t),r.d(t,{default:()=>q});r(44114),r(62010),r(2892),r(9868);var a=r(56768),n=r(95187),c=function(e){return(0,a.Qi)("data-v-f259aec6"),e=e(),(0,a.jt)(),e},i={class:"orders-page"},o={class:"container"},s=c((function(){return(0,a.Lk)("div",{class:"page-header"},[(0,a.Lk)("h1",null,"我的订单")],-1)})),u={key:0,class:"loading-container"},l={key:1,class:"error-container"},d={key:2,class:"empty-container"},p={key:3,class:"orders-list"},f={class:"order-header"},g={class:"order-info"},v={class:"order-number"},k={class:"order-date"},m={class:"order-items"},h={class:"item-info"},y=c((function(){return(0,a.Lk)("div",{class:"image-error-slot"},[(0,a.Lk)("i",{class:"el-icon-picture-outline"})],-1)})),_={class:"item-details"},C={key:0,class:"item-tags"},b={class:"item-price"},x={class:"item-quantity"},w={class:"order-footer"},L={class:"order-total"},A={class:"price"},I={class:"order-actions"},X={class:"pagination-container"};function W(e,t,r,c,W,E){var O=(0,a.g2)("el-skeleton"),S=(0,a.g2)("el-button"),T=(0,a.g2)("el-empty"),F=(0,a.g2)("el-image"),z=(0,a.g2)("el-tag"),N=(0,a.g2)("el-card"),P=(0,a.g2)("el-pagination");return(0,a.uX)(),(0,a.CE)("div",i,[(0,a.Lk)("div",o,[s,c.loading?((0,a.uX)(),(0,a.CE)("div",u,[(0,a.bF)(O,{rows:5,animated:""})])):c.error?((0,a.uX)(),(0,a.CE)("div",l,[(0,a.bF)(T,{description:"加载订单失败"},{default:(0,a.k6)((function(){return[(0,a.bF)(S,{type:"primary",onClick:c.fetchOrders},{default:(0,a.k6)((function(){return[(0,a.eW)("重试")]})),_:1},8,["onClick"])]})),_:1})])):0===c.orders.length?((0,a.uX)(),(0,a.CE)("div",d,[(0,a.bF)(T,{description:"您还没有订单"},{default:(0,a.k6)((function(){return[(0,a.bF)(S,{type:"primary",onClick:t[0]||(t[0]=function(t){return e.$router.push("/products")})},{default:(0,a.k6)((function(){return[(0,a.eW)("去购物")]})),_:1})]})),_:1})])):((0,a.uX)(),(0,a.CE)("div",p,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(c.orders,(function(e){return(0,a.uX)(),(0,a.Wv)(N,{key:e.id,class:"order-card"},{default:(0,a.k6)((function(){return[(0,a.Lk)("div",f,[(0,a.Lk)("div",g,[(0,a.Lk)("span",v,"订单号: "+(0,n.v_)(e.order_number),1),(0,a.Lk)("span",k,"下单时间: "+(0,n.v_)(c.formatDate(e.created_at)),1)]),(0,a.Lk)("div",{class:(0,n.C4)(["order-status","status-"+e.status])},(0,n.v_)(c.getStatusText(e.status)),3)]),(0,a.Lk)("div",m,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(e.items,(function(e){return(0,a.uX)(),(0,a.CE)("div",{key:e.id,class:"order-item"},[(0,a.Lk)("div",h,[(0,a.bF)(F,{src:c.getOrderItemImageUrl(e),alt:e.name,class:"item-image",onError:c.handleImageError},{error:(0,a.k6)((function(){return[y]})),_:2},1032,["src","alt","onError"]),(0,a.Lk)("div",_,[(0,a.Lk)("h4",null,(0,n.v_)(e.name),1),e.eco_certification||e.is_recyclable?((0,a.uX)(),(0,a.CE)("div",C,[e.eco_certification?((0,a.uX)(),(0,a.Wv)(z,{key:0,size:"small",type:"success"},{default:(0,a.k6)((function(){return[(0,a.eW)((0,n.v_)(e.eco_certification),1)]})),_:2},1024)):(0,a.Q3)("",!0),e.is_recyclable?((0,a.uX)(),(0,a.Wv)(z,{key:1,size:"small",type:"info"},{default:(0,a.k6)((function(){return[(0,a.eW)("可回收")]})),_:1})):(0,a.Q3)("",!0)])):(0,a.Q3)("",!0)])]),(0,a.Lk)("div",b,"¥"+(0,n.v_)(e.price&&!isNaN(e.price)?Number(e.price).toFixed(2):"0.00"),1),(0,a.Lk)("div",x,"x "+(0,n.v_)(e.quantity&&!isNaN(e.quantity)?Number(e.quantity):0),1)])})),128))]),(0,a.Lk)("div",w,[(0,a.Lk)("div",L,[(0,a.Lk)("span",null,"共 "+(0,n.v_)(c.getTotalItems(e))+" 件商品，总计：",1),(0,a.Lk)("span",A,"¥"+(0,n.v_)(c.getTotalPrice(e).toFixed(2)),1)]),(0,a.Lk)("div",I,["pending"===e.status?((0,a.uX)(),(0,a.Wv)(S,{key:0,type:"primary",size:"small",onClick:function(t){return c.payOrder(e)}},{default:(0,a.k6)((function(){return[(0,a.eW)(" 立即付款 ")]})),_:2},1032,["onClick"])):(0,a.Q3)("",!0),"pending"===e.status?((0,a.uX)(),(0,a.Wv)(S,{key:1,type:"danger",size:"small",onClick:function(t){return c.cancelOrder(e)}},{default:(0,a.k6)((function(){return[(0,a.eW)(" 取消订单 ")]})),_:2},1032,["onClick"])):(0,a.Q3)("",!0),"shipped"===e.status?((0,a.uX)(),(0,a.Wv)(S,{key:2,type:"success",size:"small",onClick:function(t){return c.confirmReceipt(e)}},{default:(0,a.k6)((function(){return[(0,a.eW)(" 确认收货 ")]})),_:2},1032,["onClick"])):(0,a.Q3)("",!0),"completed"===e.status?((0,a.uX)(),(0,a.Wv)(S,{key:3,type:"warning",size:"small",onClick:function(t){return c.reviewOrder(e)}},{default:(0,a.k6)((function(){return[(0,a.eW)(" 评价 ")]})),_:2},1032,["onClick"])):(0,a.Q3)("",!0)])])]})),_:2},1024)})),128)),(0,a.Lk)("div",X,[c.totalPages>1?((0,a.uX)(),(0,a.Wv)(P,{key:0,"current-page":c.currentPage,"page-size":10,total:c.totalOrders,onCurrentChange:c.handlePageChange,layout:"prev, pager, next"},null,8,["current-page","total","onCurrentChange"])):(0,a.Q3)("",!0)])]))])])}var E=r(14048),O=r(30388),S=(r(28706),r(64346),r(72712),r(23288),r(18111),r(18237),r(26099),r(68156),r(71798)),T=r(60782),F=r(50973),z=r(51219),N=r(91036),P=r(61981),B=r(50788),Q=r.n(B);const K={name:"Orders",setup:function(){(0,T.Pj)();var e=(0,F.rd)(),t=(0,S.KR)([]),n=(0,S.KR)(!1),c=(0,S.KR)(!1),i=(0,S.KR)(1),o=(0,S.KR)(0),s=(0,S.KR)(0),u=function(){var r=(0,O.A)((0,E.A)().mark((function r(){var a,i,u,l=arguments;return(0,E.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return a=l.length>0&&void 0!==l[0]?l[0]:1,n.value=!0,c.value=!1,r.prev=3,i=localStorage.getItem("token"),r.next=7,Q().get("/api/orders/list",{params:{page:a,size:10},headers:i?{Authorization:"Bearer ".concat(i)}:{}});case 7:u=r.sent,console.log("订单列表API返回:",u.data),u.data&&200===u.data.code&&u.data.data&&u.data.data.list?(t.value=u.data.data.list,o.value=u.data.data.total||0,s.value=Math.ceil(o.value/10)):u.data&&200===u.data.code&&Array.isArray(u.data.data)?(t.value=u.data.data,o.value=u.data.data.length,s.value=1):(console.warn("API返回格式不符合预期:",u.data),t.value=[],o.value=0,s.value=0),r.next=18;break;case 12:r.prev=12,r.t0=r["catch"](3),console.error("获取订单失败:",r.t0),c.value=!0,t.value=[],r.t0.response&&401===r.t0.response.status?(z.nk.warning("请先登录后查看订单"),e.push("/login?redirect=/orders")):z.nk.error("获取订单失败，请重试");case 18:return r.prev=18,n.value=!1,r.finish(18);case 21:case"end":return r.stop()}}),r,null,[[3,12,18,21]])})));return function(){return r.apply(this,arguments)}}(),l=function(e){return e&&e.items&&Array.isArray(e.items)?e.items.reduce((function(e,t){return e+(Number(t.quantity)||0)}),0):0},d=function(e){return e&&e.items&&Array.isArray(e.items)?e.items.reduce((function(e,t){var r=Number(t.price)||0,a=Number(t.quantity)||0;return e+r*a}),0):0},p=function(e){try{if(!e)return"暂无日期";var t=new Date(e);if(isNaN(t.getTime()))return e;var r=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),c=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0");return"".concat(r,"-").concat(a,"-").concat(n," ").concat(c,":").concat(i)}catch(o){return"日期格式错误"}},f=function(e){var t={pending:"待付款",paid:"已付款",processing:"处理中",shipped:"已发货",completed:"已完成",cancelled:"已取消",canceled:"已取消"};return t[e]||"未知状态"},g=function(e){i.value=e,u(e)},v=function(e){try{N.s.confirm("确认支付订单金额 ¥".concat(d(e).toFixed(2)," ?"),"确认支付",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((0,O.A)((0,E.A)().mark((function t(){var r,a,n;return(0,E.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if((0,z.nk)({message:"正在处理支付...",type:"info",duration:1500}),t.prev=1,r=localStorage.getItem("token"),e.id||e.order_id){t.next=7;break}return console.error("订单ID不存在:",e),z.nk.error("无法支付订单：订单ID不存在"),t.abrupt("return");case 7:return a=e.order_id||e.id,console.log("使用的订单ID:",a,"原始订单:",e),t.next=11,Q().post("/api/orders/pay",{order_id:a},{headers:r?{Authorization:"Bearer ".concat(r)}:{}});case 11:n=t.sent,n.data&&200===n.data.code?(z.nk.success("支付成功"),u(i.value)):z.nk.error(n.data.message||"支付失败，请重试"),t.next=19;break;case 15:t.prev=15,t.t0=t["catch"](1),console.error("支付失败:",t.t0),z.nk.error("支付失败，请重试");case 19:case"end":return t.stop()}}),t,null,[[1,15]])}))))["catch"]((function(){}))}catch(c){console.error("启动支付流程失败:",c),z.nk.error("启动支付流程失败")}},k=function(e){N.s.confirm("是否确认取消该订单？","取消订单",{confirmButtonText:"确认",cancelButtonText:"返回",type:"warning"}).then((0,O.A)((0,E.A)().mark((function t(){var r,a,n;return(0,E.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,r=localStorage.getItem("token"),a=e.order_id||e.id,t.next=5,Q().put("/api/orders/".concat(a,"/status"),{status:"canceled"},{headers:r?{Authorization:"Bearer ".concat(r)}:{}});case 5:n=t.sent,n.data&&200===n.data.code?(z.nk.success("订单已取消"),u(i.value)):z.nk.error(n.data.message||"取消失败"),t.next=13;break;case 9:t.prev=9,t.t0=t["catch"](0),console.error("取消订单失败:",t.t0),z.nk.error("取消订单失败");case 13:case"end":return t.stop()}}),t,null,[[0,9]])}))))["catch"]((function(){}))},m=function(e){N.s.confirm("确认已收到商品?","确认收货",{confirmButtonText:"确认",cancelButtonText:"取消",type:"info"}).then((function(){z.nk.success("确认收货成功"),u(i.value)}))["catch"]((function(){}))},h=function(t){var r=t.order_id||t.id;e.push("/review?order_id=".concat(r))},y=function(e){if(!e)return r(67015);var t=null;if(e.image_url)t=e.image_url;else if(e.product&&e.product.image_url)t=e.product.image_url;else if(e.product&&e.product.image)t=e.product.image;else if(e.product&&e.product.images&&e.product.images.length>0)t=e.product.images[0];else{if(!e.image)return console.log("订单项没有图片:",e),r(67015);t=e.image}return(0,P.m)(t)},_=function(){console.warn("订单项图片加载失败")};return(0,a.sV)((function(){u()})),{orders:t,loading:n,error:c,currentPage:i,totalOrders:o,totalPages:s,getTotalItems:l,getTotalPrice:d,formatDate:p,getStatusText:f,handlePageChange:g,fetchOrders:u,payOrder:v,cancelOrder:k,confirmReceipt:m,reviewOrder:h,getOrderItemImageUrl:y,handleImageError:_}}};var R=r(71241);const D=(0,R.A)(K,[["render",W],["__scopeId","data-v-f259aec6"]]),q=D}}]);
//# sourceMappingURL=349.3d20e840.js.map