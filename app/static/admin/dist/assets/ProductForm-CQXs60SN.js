import{a as _,h as I,i as ae,r as re,y as se,c as f,b as y,B as ne,t as v,d as r,w as n,e as d,z as ie,p as h,E as p,u as ue,o as u,g as w,G as b,F as R,n as $,j as ce,H as de}from"./index-gpBZUzsn.js";import{a as k}from"./index-t--hEgTQ.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const me={class:"product-form-container"},ge={class:"page-header"},fe={class:"page-title"},_e={class:"header-actions"},ye={key:0,class:"selected-category-info"},ve=["src"],be={key:0,class:"upload-tip"},he={key:1,class:"upload-debug"},Ve={class:"form-actions"},we={__name:"ProductForm",setup(ke){const U=ae(),B=ue(),x=_(null),L=_(!1),V=_(!1),c=_([]),m=_([]),F=_(""),C=_(!1),D=I(()=>U.params.id!==void 0),z=I(()=>{const l=localStorage.getItem("token");return{Authorization:l?`Bearer ${l}`:""}}),S=I(()=>{if(!o.category)return"";const l=m.value.find(e=>e.category_id===o.category||String(e.category_id)===String(o.category));return l?l.category_name||l.name:""}),W=["高膳食纤维","低脂肪","低糖","高蛋白","低热量","润肠通便","清热降火","血糖友好"],o=re({name:"",description:"",price:0,stock:0,category:"",eco_friendly:!1,eco_labels:[],material:"",carbon_footprint:null,images:[]}),j={name:[{required:!0,message:"请输入产品名称",trigger:"blur"},{min:2,max:100,message:"长度在 2 到 100 个字符",trigger:"blur"}],price:[{required:!0,message:"请输入产品价格",trigger:"change"},{type:"number",min:0,message:"价格必须大于等于0",trigger:"change"}],description:[{required:!0,message:"请输入产品描述",trigger:"blur"}]},H=async()=>{try{const l=await k.get("/api/products/categories");return console.log("获取到的分类数据原始结构:",l),l.data&&l.data.data?(m.value=l.data.data,console.log("最终处理后的分类列表:",m.value)):l.data&&(m.value=l.data,console.log("最终处理后的分类列表:",m.value)),Promise.resolve()}catch(l){return console.error("获取分类列表失败:",l),Promise.reject(l)}},O=async()=>{if(D.value){L.value=!0;try{const e=(await k.get(`/api/products/${U.params.id}`)).data;if(console.log("获取到的产品详情数据:",e),o.name=e.name,o.description=e.description,o.price=e.price,o.stock=e.stock,e.category!==void 0&&e.category!==null){let t=e.category;if(m.value.length>0){const s=m.value.find(g=>g.category_id===t||String(g.category_id)===String(t));s?(console.log("找到匹配的分类:",s),o.category=s.category_id):(console.warn(`分类ID ${t} 在当前分类列表中未找到匹配项`),o.category=t)}else o.category=t,console.warn("分类列表为空，使用原始分类ID")}else o.category="";console.log("设置表单分类ID为:",o.category,"类型:",typeof o.category),o.eco_friendly=e.eco_friendly,o.eco_labels=e.eco_labels||[],o.material=e.material||"",o.carbon_footprint=e.carbon_footprint;const i=e.images||[];console.log("获取到的产品图片:",i),o.images=i.map(t=>t&&!t.startsWith("http")?`https://web-production-85aa.up.railway.app${t}`:t).filter(t=>t),console.log("处理后的产品图片URLs:",o.images),c.value=o.images.map((t,s)=>({name:`图片${s+1}`,url:t,uid:`existing_${s}`,status:"success"})),console.log("初始化的文件列表:",c.value)}catch(l){console.error("获取产品详情失败:",l),p.error("获取产品详情失败，请稍后再试")}finally{L.value=!1}}},N=async()=>{x.value&&await x.value.validate(async l=>{if(!l){p.warning("请正确填写所有必填项");return}V.value=!0;try{console.log("提交前的fileList:",c.value),o.images=c.value.map(t=>t.url).filter(t=>t),console.log("提交前处理的form.images:",o.images);const e={...o};e.category&&(typeof e.category=="string"&&!isNaN(e.category)&&(e.category=parseInt(e.category)),console.log("提交前的分类ID:",e.category,"类型:",typeof e.category)),console.log("提交的表单数据:",e);let i;D.value?(i=await k.put(`/api/products/${U.params.id}`,e),p.success("产品更新成功")):(i=await k.post("/api/products",e),p.success("产品创建成功")),B.push("/products")}catch(e){console.error("保存产品失败:",e),p.error("保存失败，请检查网络连接或稍后再试")}finally{V.value=!1}})},P=()=>{B.push("/products")},A=(l,e,i)=>{console.log("图片上传响应:",l),console.log("当前上传文件:",e),console.log("上传文件列表:",i);let t="";if(l.url?t=l.url:l.data&&l.data.url&&(t=l.data.url),t&&!t.startsWith("http")&&(t=`https://web-production-85aa.up.railway.app${t}`),console.log("设置图片URL:",t),t){e.url=t;const s=c.value.find(g=>g.uid===e.uid);s?s.url=t:c.value.push({name:e.name,url:t,uid:e.uid||Date.now().toString()}),o.images.includes(t)||o.images.push(t),console.log("更新后的fileList:",c.value),console.log("更新后的form.images:",o.images)}p.success("图片上传成功")},G=l=>{console.error("上传失败:",l),p.error("图片上传失败，请稍后重试")},K=(l,e)=>{if(console.log("移除图片:",l),l.url){const i=o.images.indexOf(l.url);i!==-1?(o.images.splice(i,1),console.log("从form.images移除图片URL:",l.url),console.log("当前form.images:",o.images)):console.warn("在form.images中未找到要移除的图片URL:",l.url)}},T=l=>{console.log("预览图片:",l),l&&l.url?(F.value=l.url,C.value=!0):p.warning("图片预览失败，URL不存在")},J=l=>l.type.startsWith("image/")?l.size/1024/1024<2?!0:(p.error("图片大小不能超过2MB!"),!1):(p.error("只能上传图片文件!"),!1),Q=(l,e)=>{console.log("文件变化:",l),console.log("变化后的文件列表:",e)};return se(()=>{H().then(()=>{O()})}),(l,e)=>{const i=d("el-button"),t=d("el-input"),s=d("el-form-item"),g=d("el-input-number"),E=d("el-option"),M=d("el-select"),X=d("el-switch"),Y=d("el-icon"),Z=d("el-upload"),ee=d("el-dialog"),oe=d("el-form"),le=d("el-card"),te=ie("loading");return u(),f("div",me,[y("div",ge,[y("h1",fe,v(D.value?"编辑产品":"添加产品"),1),y("div",_e,[r(i,{onClick:P},{default:n(()=>e[10]||(e[10]=[w("返回")])),_:1}),r(i,{type:"primary",onClick:N,loading:V.value},{default:n(()=>e[11]||(e[11]=[w("保存")])),_:1},8,["loading"])])]),ne((u(),h(le,{class:"form-card",shadow:"never"},{default:n(()=>[r(oe,{ref_key:"formRef",ref:x,model:o,rules:j,"label-width":"120px","label-position":"left",class:"product-form"},{default:n(()=>[r(s,{label:"产品名称",prop:"name"},{default:n(()=>[r(t,{modelValue:o.name,"onUpdate:modelValue":e[0]||(e[0]=a=>o.name=a),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),r(s,{label:"产品价格",prop:"price"},{default:n(()=>[r(g,{modelValue:o.price,"onUpdate:modelValue":e[1]||(e[1]=a=>o.price=a),min:0,precision:2,step:.01,placeholder:"请输入产品价格",style:{width:"180px"}},null,8,["modelValue"])]),_:1}),r(s,{label:"库存数量",prop:"stock"},{default:n(()=>[r(g,{modelValue:o.stock,"onUpdate:modelValue":e[2]||(e[2]=a=>o.stock=a),min:0,precision:0,placeholder:"请输入库存数量",style:{width:"180px"}},null,8,["modelValue"])]),_:1}),r(s,{label:"产品分类",prop:"category"},{default:n(()=>[r(M,{modelValue:o.category,"onUpdate:modelValue":e[3]||(e[3]=a=>o.category=a),placeholder:"请选择产品分类",style:{width:"180px"}},{default:n(()=>[(u(!0),f(R,null,$(m.value,a=>(u(),h(E,{key:a.category_id,label:a.category_name||a.name,value:a.category_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o.category&&S.value?(u(),f("span",ye," 当前选择: "+v(S.value),1)):b("",!0)]),_:1}),r(s,{label:"更多属性"},{default:n(()=>[r(X,{modelValue:o.eco_friendly,"onUpdate:modelValue":e[4]||(e[4]=a=>o.eco_friendly=a),"active-text":"详细描述","inactive-text":"普通描述","inline-prompt":""},null,8,["modelValue"])]),_:1}),o.eco_friendly?(u(),h(s,{key:0,label:"营养标签"},{default:n(()=>[r(M,{modelValue:o.eco_labels,"onUpdate:modelValue":e[5]||(e[5]=a=>o.eco_labels=a),multiple:"",filterable:"","allow-create":"","default-first-option":"",placeholder:"请选择营养标签",style:{width:"100%"}},{default:n(()=>[(u(),f(R,null,$(W,a=>r(E,{key:a,label:a,value:a},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})):b("",!0),o.eco_friendly?(u(),h(s,{key:1,label:"蔬菜瓜果类型"},{default:n(()=>[r(t,{modelValue:o.material,"onUpdate:modelValue":e[6]||(e[6]=a=>o.material=a),placeholder:"请输入蔬菜瓜果类型"},null,8,["modelValue"])]),_:1})):b("",!0),o.eco_friendly?(u(),h(s,{key:2,label:"每件重量"},{default:n(()=>[r(g,{modelValue:o.carbon_footprint,"onUpdate:modelValue":e[7]||(e[7]=a=>o.carbon_footprint=a),min:0,precision:2,step:.1,placeholder:"请输入每件重量",style:{width:"180px"}},null,8,["modelValue"]),e[12]||(e[12]=y("span",{class:"carbon-unit"},"Kg",-1))]),_:1})):b("",!0),r(s,{label:"产品描述",prop:"description"},{default:n(()=>[r(t,{modelValue:o.description,"onUpdate:modelValue":e[8]||(e[8]=a=>o.description=a),type:"textarea",rows:4,placeholder:"请输入产品描述"},null,8,["modelValue"])]),_:1}),r(s,{label:"产品图片"},{default:n(()=>[r(Z,{class:"product-image-uploader",action:"/api/upload/image",headers:z.value,multiple:!0,"list-type":"picture-card","file-list":c.value,"on-preview":T,"on-remove":K,"on-success":A,"on-error":G,limit:5,"before-upload":J,"on-change":Q,"auto-upload":!0},{default:n(()=>[r(Y,null,{default:n(()=>[r(ce(de))]),_:1})]),_:1},8,["headers","file-list"]),r(ee,{modelValue:C.value,"onUpdate:modelValue":e[9]||(e[9]=a=>C.value=a)},{default:n(()=>[y("img",{"w-full":"",src:F.value,alt:"预览图",style:{"max-width":"100%"}},null,8,ve)]),_:1},8,["modelValue"]),c.value.length>0?(u(),f("div",be," 已上传 "+v(c.value.length)+" 张图片，最多可上传 5 张 ",1)):b("",!0),c.value.length>0?(u(),f("div",he,[e[13]||(e[13]=y("div",null,"图片列表:",-1)),(u(!0),f(R,null,$(c.value,(a,q)=>(u(),f("div",{key:q,class:"debug-item"},v(q+1)+". "+v(a.name)+" - "+v(a.url),1))),128))])):b("",!0)]),_:1})]),_:1},8,["model"])]),_:1})),[[te,L.value]]),y("div",Ve,[r(i,{onClick:P},{default:n(()=>e[14]||(e[14]=[w("取消")])),_:1}),r(i,{type:"primary",onClick:N,loading:V.value},{default:n(()=>e[15]||(e[15]=[w("保存")])),_:1},8,["loading"])])])}}},Ce=pe(we,[["__scopeId","data-v-d3092b82"]]);export{Ce as default};
