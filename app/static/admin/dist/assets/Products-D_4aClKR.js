import{a as P,r as $,y as I,c as b,b as m,d as t,w as l,e as i,E as h,u as ee,z as te,o as c,g as u,F as D,n as N,p as y,B as ae,j as z,C as oe,D as j,t as V,G as le,v as T}from"./index-gpBZUzsn.js";import{a as F}from"./index-t--hEgTQ.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";const se={class:"products-container"},re={class:"page-header"},ie={class:"header-actions"},de={class:"no-image"},ce={class:"image-loading"},pe={key:1,class:"no-image"},ue={key:0},ge={class:"pagination-container"},me={__name:"Products",setup(_e){const B=ee(),k=P(!1),U=P([]),v=P([]),d=$({page:1,perPage:10,total:0}),s=$({name:"",category:"",ecoFriendly:""}),_=async()=>{k.value=!0;try{const a={page:d.page,per_page:d.perPage};s.name&&(a.name=s.name),s.category&&(a.category=s.category),s.ecoFriendly&&(a.eco_friendly=s.ecoFriendly);const e=await F.get("/api/products",{params:a}),r=e.data.items.map(n=>(n.images&&n.images.length>0&&(n.images=n.images.map(g=>g&&!g.startsWith("http")?`https://web-production-85aa.up.railway.app${g}`:g)),typeof n.eco_labels=="string"&&n.eco_labels?n.eco_labels=n.eco_labels.split(","):Array.isArray(n.eco_labels)||(n.eco_labels=[]),n));console.log("处理后的产品数据:",r),U.value=r,d.total=e.data.total}catch(a){console.error("获取产品列表失败:",a),h.error("获取产品列表失败，请稍后重试")}finally{k.value=!1}},A=async()=>{try{const a=await F.get("/api/products/categories");return console.log("Products页面获取到的分类数据:",a),a.data&&a.data.data?v.value=a.data.data:a.data&&(v.value=a.data),Promise.resolve()}catch(a){return console.error("获取分类列表失败:",a),Promise.reject(a)}},M=a=>{if(!a)return"未分类";const e=v.value.find(r=>r.category_id===a||String(r.category_id)===String(a));return e?e.category_name||e.name:a},L=()=>{d.page=1,_()},R=()=>{s.name="",s.category="",s.ecoFriendly="",d.page=1,_()},G=a=>{d.perPage=a,_()},W=a=>{d.page=a,_()},q=()=>{B.push("/products/add")},H=a=>{B.push(`/products/edit/${a.id}`)},J=a=>{T.confirm(`确定要删除产品 "${a.name}" 吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const e=await F.delete(`/api/products/${a.id}`);h.success("删除成功"),_()}catch(e){if(console.error("删除产品失败:",e),e.response){const{status:r,data:n}=e.response;r===400&&n.referenced_by_orders?T.alert(n.message||"该产品已被订单引用，无法删除。","无法删除产品",{confirmButtonText:"我知道了",type:"warning"}):h.error(n.message||"删除产品失败，请稍后重试")}else h.error("删除产品失败，请检查网络连接")}}).catch(()=>{})},K=(a,e)=>{if(console.error("图片加载失败:",a,e),e.images&&e.images.length>0){const r=e.images[0];console.log("原始图片URL:",r)}};return I(()=>{A().then(()=>{_()})}),(a,e)=>{const r=i("el-button"),n=i("el-input"),g=i("el-form-item"),w=i("el-option"),E=i("el-select"),O=i("el-form"),S=i("el-card"),p=i("el-table-column"),x=i("el-icon"),Q=i("el-image"),C=i("el-tag"),X=i("el-table"),Y=i("el-pagination"),Z=te("loading");return c(),b("div",se,[m("div",re,[e[6]||(e[6]=m("h1",{class:"page-title"},"产品管理",-1)),m("div",ie,[t(r,{type:"primary",onClick:q},{default:l(()=>e[5]||(e[5]=[u("添加产品")])),_:1})])]),t(S,{class:"filter-container",shadow:"never"},{default:l(()=>[t(O,{inline:!0,model:s,class:"filter-form"},{default:l(()=>[t(g,{label:"产品名称"},{default:l(()=>[t(n,{modelValue:s.name,"onUpdate:modelValue":e[0]||(e[0]=o=>s.name=o),placeholder:"输入关键词搜索"},null,8,["modelValue"])]),_:1}),t(g,{label:"分类"},{default:l(()=>[t(E,{modelValue:s.category,"onUpdate:modelValue":e[1]||(e[1]=o=>s.category=o),placeholder:"所有分类",clearable:""},{default:l(()=>[(c(!0),b(D,null,N(v.value,o=>(c(),y(w,{key:o.category_id,label:o.category_name||o.name,value:o.category_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"更多属性"},{default:l(()=>[t(E,{modelValue:s.ecoFriendly,"onUpdate:modelValue":e[2]||(e[2]=o=>s.ecoFriendly=o),placeholder:"更多属性",clearable:""},{default:l(()=>[t(w,{label:"详细描述",value:"true"}),t(w,{label:"普通描述",value:"false"})]),_:1},8,["modelValue"])]),_:1}),t(g,null,{default:l(()=>[t(r,{type:"primary",onClick:L},{default:l(()=>e[7]||(e[7]=[u("搜索")])),_:1}),t(r,{onClick:R},{default:l(()=>e[8]||(e[8]=[u("重置")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(S,{class:"table-container",shadow:"never"},{default:l(()=>[ae((c(),y(X,{data:U.value,style:{width:"100%"},border:""},{default:l(()=>[t(p,{type:"index",width:"50"}),t(p,{label:"产品图片",width:"100"},{default:l(o=>[o.row.images&&o.row.images.length>0?(c(),y(Q,{key:0,src:o.row.images[0],"preview-src-list":o.row.images,fit:"cover",style:{width:"80px",height:"80px","border-radius":"4px","object-fit":"cover"},"initial-index":0,onError:f=>K(f,o.row),loading:"lazy"},{error:l(()=>[m("div",de,[t(x,null,{default:l(()=>[t(z(j))]),_:1}),e[9]||(e[9]=m("p",{class:"load-error-text"},"加载失败",-1))])]),placeholder:l(()=>[m("div",ce,[t(x,{class:"is-loading"},{default:l(()=>[t(z(oe))]),_:1})])]),_:2},1032,["src","preview-src-list","onError"])):(c(),b("div",pe,[t(x,null,{default:l(()=>[t(z(j))]),_:1}),e[10]||(e[10]=m("p",{class:"no-image-text"},"无图片",-1))]))]),_:1}),t(p,{prop:"name",label:"名称","min-width":"200"}),t(p,{prop:"price",label:"价格",width:"120"},{default:l(o=>[u(" ¥ "+V(o.row.price.toFixed(2)),1)]),_:1}),t(p,{prop:"stock",label:"库存",width:"100"}),t(p,{label:"分类",width:"120"},{default:l(o=>[u(V(M(o.row.category)),1)]),_:1}),t(p,{label:"更多属性",width:"120"},{default:l(o=>[o.row.eco_friendly?(c(),y(C,{key:0,type:"success",size:"small",effect:"plain"},{default:l(()=>e[11]||(e[11]=[u(" 详细描述 ")])),_:1})):(c(),y(C,{key:1,size:"small",effect:"plain",type:"info"},{default:l(()=>e[12]||(e[12]=[u(" 普通描述 ")])),_:1}))]),_:1}),t(p,{label:"营养标签","min-width":"180"},{default:l(o=>[(c(!0),b(D,null,N(o.row.eco_labels,f=>(c(),y(C,{key:f,type:"success",class:"eco-tag",size:"small"},{default:l(()=>[u(V(f),1)]),_:2},1024))),128)),!o.row.eco_labels||o.row.eco_labels.length===0?(c(),b("span",ue,"无")):le("",!0)]),_:1}),t(p,{label:"创建时间",prop:"created_at","min-width":"180"}),t(p,{label:"操作",width:"140"},{default:l(o=>[t(r,{size:"small",type:"primary",onClick:f=>H(o.row),link:""},{default:l(()=>e[13]||(e[13]=[u("编辑")])),_:2},1032,["onClick"]),t(r,{size:"small",type:"danger",onClick:f=>J(o.row),link:""},{default:l(()=>e[14]||(e[14]=[u("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Z,k.value]]),m("div",ge,[t(Y,{"current-page":d.page,"onUpdate:currentPage":e[3]||(e[3]=o=>d.page=o),"page-size":d.perPage,"onUpdate:pageSize":e[4]||(e[4]=o=>d.perPage=o),total:d.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:G,onCurrentChange:W},null,8,["current-page","page-size","total"])])]),_:1})])}}},ve=ne(me,[["__scopeId","data-v-247d23eb"]]);export{ve as default};
